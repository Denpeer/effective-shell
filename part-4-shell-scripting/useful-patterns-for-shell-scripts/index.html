<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-155335600-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-155335600-1",{anonymize_ip:!0})</script><title data-react-helmet="true">Useful Patterns for Shell Scripts | Effective Shell</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://effective-shell.com/part-4-shell-scripting/useful-patterns-for-shell-scripts"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Useful Patterns for Shell Scripts | Effective Shell"><meta data-react-helmet="true" name="description" content="To close this the section on shell scripting we&#x27;re going to look at some common patterns you will see in shell scripts. These are an assortment of techniques you may find useful when building your scripts - you may come across them in scripts others have written as well."><meta data-react-helmet="true" property="og:description" content="To close this the section on shell scripting we&#x27;re going to look at some common patterns you will see in shell scripts. These are an assortment of techniques you may find useful when building your scripts - you may come across them in scripts others have written as well."><link data-react-helmet="true" rel="icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://effective-shell.com/part-4-shell-scripting/useful-patterns-for-shell-scripts"><link data-react-helmet="true" rel="alternate" href="https://effective-shell.com/part-4-shell-scripting/useful-patterns-for-shell-scripts" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://effective-shell.com/part-4-shell-scripting/useful-patterns-for-shell-scripts" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.078694be.css">
<link rel="preload" href="/assets/js/runtime~main.9510d0b1.js" as="script">
<link rel="preload" href="/assets/js/main.3718e50c.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Effective Shell Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.png" alt="Effective Shell Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Effective Shell</b></a><a class="navbar__item navbar__link navbar__link--active" href="/">Home</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Effective Shell</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-1-transitioning-to-the-shell/">Transitioning to the Shell</a><button aria-label="Toggle the collapsible sidebar category &#x27;Transitioning to the Shell&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-2-core-skill/">Core Skills</a><button aria-label="Toggle the collapsible sidebar category &#x27;Core Skills&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-3-manipulating-text/">Manipulating Text and Streams</a><button aria-label="Toggle the collapsible sidebar category &#x27;Manipulating Text and Streams&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/part-4-shell-scripting/">Shell Scripting</a><button aria-label="Toggle the collapsible sidebar category &#x27;Shell Scripting&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/part-3-manipulating-text/shell-script-essentials/">Shell Script Essentials</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/part-3-manipulating-text/variables-reading-input-and-mathematics/">Variables, Reading Input, and Mathematics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/part-4-shell-scripting/mastering-conditional-logic">Mastering Conditional Logic</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/part-4-shell-scripting/loops-and-working-with-files-and-folders">Loops and working with Files and Folders</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/part-4-shell-scripting/functions-parameters-and-error-handling">Functions, Parameters and Error Handling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/part-4-shell-scripting/useful-patterns-for-shell-scripts">Useful Patterns for Shell Scripts</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-5-building-your-toolkit/">Building Your Toolkit</a><button aria-label="Toggle the collapsible sidebar category &#x27;Building Your Toolkit&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/part-6-advanced-techniques/">Advanced Techniques</a><button aria-label="Toggle the collapsible sidebar category &#x27;Advanced Techniques&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Useful Patterns for Shell Scripts</h1></header><p>To close this the section on shell scripting we&#x27;re going to look at some common patterns you will see in shell scripts. These are an assortment of techniques you may find useful when building your scripts - you may come across them in scripts others have written as well.</p><p>Remember that although this chapter focuses on patterns that are useful in scripts, you can apply these patterns in any shell session. This means you might find this chapter useful even if you are not expecting to write scripts, just as a way to understand some more advanced shell techniques.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ensuring-exit-on-failure">Ensuring Exit on Failure<a class="hash-link" href="#ensuring-exit-on-failure" title="Direct link to heading">â€‹</a></h2><p>By default, shell scripts will continue to execute if a command fails. This behaviour makes sense when running an interactive shell - we don&#x27;t want the shell to close if a command fails. For a shell script however, continuing after an error has occurred is most likely going to lead to unexpected behaviour.</p><p>There are two options that you will often see set at the top of a script:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">set</span><span class="token plain"> -e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -o pipefail</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The first option ensures that the shell script will abort if a command fails.</p><p>The second option ensures that if a command that is part of a pipeline fails, then the shell script fails. Even when the <code>set -e</code> option is set, only the final command in a pipeline will cause the script to exit if it fails.</p><p>Here&#x27;s an example showing why these options are useful:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Create the effective shell folder.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p ~/effective-shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Download and untar the effective shell samples.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">samples_uri</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;https://https://effective-shell.com/downloads/effective-shell-samples.tar.gz&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> -c </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${samples_uri}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -O - </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -xz -C ~/effective-shell</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If we don&#x27;t include the <code>set -e</code> option, then if the <code>mkdir -p</code> command fails, the script will continue to run. We will then attempt to download and untar a file into a folder that does not exist. Why would <code>mkdir -p</code> fail? Although <code>mkdir -p</code> succeeds even if the folder exists, it will still fail if there is a file in the location specified, or there are not permissions to create the folder and so on. So even commands that you assume should run successfully you have to be careful with.</p><p>In the second part of this snippet, we use the <code>wget</code> (<em>web get</em>) command to download the samples and pipe the results to <code>tar</code> to extract them. If we have <em>only</em> set <code>set -e</code>, then if <code>wget</code> fails (for example if the address is wrong or we are offline) then the shell will not abort the script and continue trying to run the subsequent commands, which are not going to work as expected.</p><p>If you have a command that you expect may fail, but want to continue execution even if it does fail, then use the <code>||</code> operator:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Remove the shell configuration.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string environment constant" style="color:#36acaa">$HOME</span><span class="token string" style="color:#e3116c">/.shell.sh&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In this case I have used a conditional operator, as described in <a href="/part-4-shell-scripting/mastering-conditional-logic">Chapter 20 - Mastering Conditional Logic</a>, to ensure that even if the <code>rm</code> command fails for some reason, the overall result of the statement will be true and the script will not exit.</p><p>Check Chapter <a href="/part-4-shell-scripting/functions-parameters-and-error-handling">Chapter 22 - Functions, Parameters and Error Handling</a> if you need a refresher on the <code>set -e</code> or <code>set -o pipefail</code> commands.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="debugging-shell-scripts">Debugging Shell Scripts<a class="hash-link" href="#debugging-shell-scripts" title="Direct link to heading">â€‹</a></h2><p>You can use the <code>set</code> (<em>set option</em>) command to set the <em>trace option</em>.<!-- --> This option is incredibly useful for debugging shell scripts. When the trace option is set, the shell will write out each statement before it is evaluated.</p><p>Let&#x27;s see just how useful this is with an example!</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># today.sh - creates a &#x27;today&#x27; symlink in the home directory folder to a fresh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># temporary folder each day.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Enable tracing in the script.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Get today&#x27;s date in the format YYYY-MM-DD.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">today</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">date</span><span class="token variable" style="color:#36acaa"> +</span><span class="token variable string" style="color:#e3116c">&quot;%Y-%m-%d&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create the path to today&#x27;s temp folder and then make sure the folder exists.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">temp_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/tmp/</span><span class="token string variable" style="color:#36acaa">${today}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${temp_path}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Now that we&#x27;ve created the folder, make a symlink to it in our homedir.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ln</span><span class="token plain"> -sf </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${temp_path}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${</span><span class="token string variable environment constant" style="color:#36acaa">HOME</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">/today&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Disable tracing now that we are done with the work.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> +x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Write out the path we created.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${temp_path}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that we use <code>set -x</code> to enable tracing early on in the script, and <code>set +x</code> to disable tracing towards the end. If we run this script, we&#x27;ll see the following output:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ~/effective-shell/scripts/today.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ date +%Y-%m-%d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ today=2021-05-29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ temp_path=/tmp/2021-05-29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ mkdir -p /tmp/2021-05-29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ ln -sf /tmp/2021-05-29 /home/dwmkerr/today</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ set +x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/2021-05-29</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Each command that the shell executes is written to <em>stdout</em> before it is executed. The parameters are expanded, which can make it far easier to see what is going on and troubleshoot issues.</p><p>The <code>+</code> symbol is written at the start of each trace line, so that you can differentiate it from normal output that you write in your script<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>. The final line of output in the example above does not have a <code>+</code> in front of it - because it is actual output from an <code>echo</code> command, rather than a trace line.</p><p>The number of <code>+</code> symbols indicates the &#x27;level of indirection&#x27; - this is how many sub-shells you are in. Each subshell is traced on its own line. This makes tracing complex commands far easier:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">set</span><span class="token plain"> -x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Name of home folder is </span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">basename</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable punctuation" style="color:#393A34">$(</span><span class="token string variable" style="color:#36acaa">echo ~</span><span class="token string variable punctuation" style="color:#393A34">)</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The output of this command is:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">+++ </span><span class="token builtin class-name">echo</span><span class="token plain"> /home/dwmkerr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">++ </span><span class="token function" style="color:#d73a49">basename</span><span class="token plain"> /home/dwmkerr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Name of home folder is dwmkerr&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name of home folder is dwmkerr</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that each subshell command is shown with an additional plus as it gets more nested. The nested commands are shown in the order that they are evaluated.</p><p>I often start my shell scripts with a snippet like this:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Fail on errors in commands or in pipelines.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> -o pipefail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Uncomment the below if you want to enable tracing to debug the script.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># set -x</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This combines the first two patterns we&#x27;ve seen - failing on errors and having the option to trace a script.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="checking-for-existing-variables-or-functions">Checking for Existing Variables or Functions<a class="hash-link" href="#checking-for-existing-variables-or-functions" title="Direct link to heading">â€‹</a></h2><p>The <code>declare</code> (<em>set variable values and attributes</em>)<!-- --> command can be used to explicitly declare that we are creating a variable. We saw in <a href="/part-3-manipulating-text/variables-reading-input-and-mathematics/">Chapter 19 - Variables, Reading Input, and Mathematics</a> that sometimes this command is required - if we want to create an associative array for example.</p><p>There are a number of options for the &#x27;declare&#x27; command, but one that is particularly useful is the <code>-p</code> (<em>display attributes and value</em>) option. This can be used to show all of the variables of a certain type.</p><p>Here&#x27;s an example to show all associative arrays that have been created:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ declare -p -A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">declare -A BASH_ALIASES=()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">declare -A BASH_CMDS=()</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can also use this command to validate whether a variable has been set or not:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin class-name">declare</span><span class="token plain"> -p -A my_options </span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> /dev/null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&#x27;my_options&#x27; exists&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&#x27;my_options&#x27; does not exist&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We have to silence the error output of the <code>declare</code> command unless we want it to print an message if the variable doesn&#x27;t exist. This technique can be useful to use before setting variables to ensure that they are not already in use, or check that the variable exists.</p><p>Functions are also variables - so we can use this trick to show all functions that are declared, the value of a function, or check if a function exists.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="unsetting-values">Unsetting Values<a class="hash-link" href="#unsetting-values" title="Direct link to heading">â€‹</a></h2><p>If you are writing a script that should clean up after itself, you might want to use the <code>unset</code> (<em>unset values and attributes</em>) command. This can be useful if you want to create a script that leaves behind no variables or functions that could cause issues for later users:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Remove the &#x27;is_even&#x27; function from the shell session.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">unset</span><span class="token plain"> -f is_even</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="traps">Traps<a class="hash-link" href="#traps" title="Direct link to heading">â€‹</a></h2><p>You can use the <code>trap</code> (<em>trap signals and events</em>) command to specify a set of commands to run when the shell receives signals, or at certain points such as when the script exits or a function returns.</p><p>A very common use for traps is to create a &#x27;cleanup&#x27; function that is executed when the script exits or if the user aborts execution by pressing <code>Ctrl+C</code> (which sends the <code>SIGINT</code> signal).</p><p>Here&#x27;s an example of how a <code>trap</code> can be set to cleanup a temporary folder when a script exits or is interrupted:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Create a temporary folder for the effective shell download.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">source</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;https://effective-shell.com/downloads/effective-shell-samples.tar.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">tmp_dir</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">mktemp -d </span><span class="token variable operator file-descriptor important" style="color:#393A34">2</span><span class="token variable operator" style="color:#393A34">&gt;</span><span class="token variable" style="color:#36acaa">/dev/null </span><span class="token variable operator" style="color:#393A34">||</span><span class="token variable" style="color:#36acaa"> mktemp -d -t </span><span class="token variable string" style="color:#e3116c">&#x27;effective-shell&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">tmp_tar</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${tmp_dir}</span><span class="token string" style="color:#e3116c">/effective-shell.tar.gz&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Define a cleanup function that we will call when the script exits or if</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># it is aborted.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">cleanup</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${tmp_tar}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$tmp_tar</span><span class="token string" style="color:#e3116c">}&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -d </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${tmp_dir}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${tmp_dir}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Cleanup on interrupt or terminate signals and on exit.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">trap</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cleanup&quot;</span><span class="token plain"> INT </span><span class="token environment constant" style="color:#36acaa">TERM</span><span class="token plain"> EXIT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Download the samples.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> --fail --compressed -q -s </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${source}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -o </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${tmp_tar}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Extract the samples.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -xzf </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${tmp_tar}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> -C </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${tmp_dir}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In this script we have defined a function called &#x27;cleanup&#x27;. We then use the <code>trap</code> command to ensure that we call the function if <code>INT</code> is sent, <code>TERM</code> is sent or when the script exits. This is very useful in scripts that can take a while. This script downloads the effective shell samples from the internet. If the user is having connectivity issues then this might take a while and they may end up aborting the script. If they do so in this case we will still clean up the temporary folder we created.</p><p>Traps provide a very convenient way to handle things like cleanup, provide more diagnostic information or even disable a user from interrupting your script. In the example below we force the user to press Ctrl+C twice if they want to interrupt the script:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">interrupt_count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">on_interrupt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$interrupt_count</span><span class="token plain"> -lt </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Aborting this operation can cause errors.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Press Ctrl+C again if you are sure you want to cancel.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">interrupt_count</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa">interrupt_count </span><span class="token variable operator" style="color:#393A34">+</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Convention is to use the status code 130 for interrupted scripts.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Aborting long operation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">130</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">trap</span><span class="token plain"> on_interrupt INT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">total_time</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Long operation: </span><span class="token string variable" style="color:#36acaa">${total_time}</span><span class="token string" style="color:#e3116c"> seconds elapsed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">total_time</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa">total_time </span><span class="token variable operator" style="color:#393A34">+</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">3</span><span class="token variable" style="color:#36acaa">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If we run this script we can see that the user must press Ctrl+C twice to abort the operation:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ ~/effective-shell/scripts/long-operation.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Long operation: 0 seconds elapsed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Long operation: 3 seconds elapsed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Long operation: 6 seconds elapsed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^CAborting this operation can cause errors.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Press Ctrl+C again if you are sure you want to cancel.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Long operation: 9 seconds elapsed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Long operation: 12 seconds elapsed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">^CAborting long operation</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Some other things that you might want to be aware of for the trap command are:</p><ul><li>The <code>SIG</code> at the beginning of the name of a signal is optional but not supported in all shells, and a signal number can also be used - this means that <code>SIGINT</code>, <code>INT</code> and <code>2</code> are all equivalent options for <code>trap</code>, but <code>INT</code> is the most portable and easiest to read!</li><li>You can list the signals available with <code>trap -l</code> or <code>kill -l</code> - but remember that special conditions such as <code>EXIT</code> and <code>RETURN</code> are not listed, you can find these with <code>help trap</code></li><li>You can stop a signal from being processed with <code>trap &quot;&quot; INT</code> - this means that no command will be executed when we receive a <code>INT</code></li><li>You can reset a trap by running <code>trap - INT</code>, this will remove any trap handler</li><li>You can test your traps by sending a signal explicitly to your script with <code>kill -s INT</code>, providing the name of the signal</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="handling-options">Handling Options<a class="hash-link" href="#handling-options" title="Direct link to heading">â€‹</a></h2><p>You can use the <code>getopts</code> (<em>parse option arguments</em>) command to process the arguments for a script or function </p><p>Let&#x27;s imagine we wanted to update our &#x27;common&#x27; command to support the following options:</p><ul><li><code>-h</code> for &#x27;help&#x27;, which shows command help</li><li><code>-e</code> for &#x27;execute&#x27;, which takes the number of a command from the list which will be executed</li></ul><p>The &#x27;getopts&#x27; command takes two parameters. The first is an &#x27;option string&#x27;, which is a list of the parameter letters that are allowed. This string starts with a colon, and any letter which is followed by a colon is expected to have a value provided. The second parameter is the name of the variable to set when we are processing options.</p><p>Typically this command is used in a while loop, as it will return &#x27;success&#x27; until the final option has been processed. A case statement is typically used to process the option:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Helper function to show how the command should be invoked.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function-name function" style="color:#d73a49">show_help</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;usage:&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;  common [-h] [-e &lt;command_number&gt;] count&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Process the options.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token builtin class-name">getopts</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:he:&quot;</span><span class="token plain"> option</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${option}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Handle the &#x27;help&#x27; option.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            show_help</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Handle the &#x27;execute command&#x27; option by storing the value provided</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># for the option.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token assign-left variable" style="color:#36acaa">execute_command</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${OPTARG}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># If we have an invalid argument, warn and fail.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">? </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The value &#x27;</span><span class="token string variable" style="color:#36acaa">${OPTARG}</span><span class="token string" style="color:#e3116c">&#x27; is not a valid option&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># If we are missing a required argument, warn and exit.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The option &#x27;</span><span class="token string variable" style="color:#36acaa">${OPTARG}</span><span class="token string" style="color:#e3116c">&#x27; requires an argument&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There are a few things to point out from this script:</p><ul><li>The option string starts with a colon - any option letter that is followed by a colon expects an argument</li><li>If an invalid option letter is set, the value of the option variable is set to <code>\?</code> - we can then handle this in our case statement</li><li>If a letter is provided without an argument that is required, the value of the option variable is set to <code>:</code> - we can then handle this in our case statement</li></ul><p>For complex option processing you might see scripts where multiple loops are used to process sets of options. It is common to end option processing with the following line:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">shift</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa">OPTIND </span><span class="token variable operator" style="color:#393A34">-</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">))</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The <code>${OPTIND}</code> variable stores the index of the last option processed. By shifting by this value minus one, we remove the processed options from the <code>$@</code> (all parameters) array. This means we don&#x27;t try to process the same options again.</p><p>The <em>~/effective-shell/scripts/common.sh</em> script processes parameters using the <code>getopts</code> command. You can use this as an example to help you with your own scripts.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="colouring-output">Colouring Output<a class="hash-link" href="#colouring-output" title="Direct link to heading">â€‹</a></h2><p>There are special escape sequences that can be used in the shell to colour the output of the text shown. For example, in many terminals the following text will be shown in green:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">green</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;</span><span class="token string entity" style="color:#36acaa">\e</span><span class="token string" style="color:#e3116c">[0;32m&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">reset</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;</span><span class="token string entity" style="color:#36acaa">\e</span><span class="token string" style="color:#e3116c">[0m&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&quot;Do you like </span><span class="token string variable" style="color:#36acaa">${green}</span><span class="token string" style="color:#e3116c">apples</span><span class="token string variable" style="color:#36acaa">${reset}</span><span class="token string" style="color:#e3116c">?&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>On most terminals you will see the text below, with the word &#x27;apples&#x27; rendered in green:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Do you like apples?</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note that it is important to provide the <code>-e</code> flag to the &#x27;echo&#x27; command so that it correctly processes the colour codes. In fact, a better option is to use the <code>printf</code> (<em>format and print arguments</em>)<!-- --> command, as it is more portable and behaves more consistently across different versions of Unix and Linux.</p><p>The colour codes are ANSI escape sequences that have been defined to control the formatting of content in a terminal. There are number of formatting options - such as foreground and background colours, bold, underline and so on. These codes can be quickly found online if you search for &quot;ANSI color codes&quot;.</p><p>It is important to be careful when using colour codes - you don&#x27;t want them in all circumstances. Let&#x27; see an example. The &#x27;rainbow&#x27; function below writes out a message in a number of colours:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function-name function" style="color:#d73a49">rainbow</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">message</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">reset</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;</span><span class="token string entity" style="color:#36acaa">\e</span><span class="token string" style="color:#e3116c">[0m&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token variable punctuation" style="color:#393A34">((</span><span class="token variable" style="color:#36acaa">colour</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable number" style="color:#36acaa">31</span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa"> colour</span><span class="token variable operator" style="color:#393A34">&lt;=</span><span class="token variable number" style="color:#36acaa">37</span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa"> colour</span><span class="token variable operator" style="color:#393A34">++</span><span class="token variable punctuation" style="color:#393A34">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">colour_code</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\\</span><span class="token string" style="color:#e3116c">e[0;</span><span class="token string variable" style="color:#36acaa">${colour}</span><span class="token string" style="color:#e3116c">m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">printf</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${colour}</span><span class="token string" style="color:#e3116c"> - </span><span class="token string variable" style="color:#36acaa">${colour_code}</span><span class="token string variable" style="color:#36acaa">${message}</span><span class="token string variable" style="color:#36acaa">${reset}</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If we run this function in most terminals, we&#x27;ll see the provided message with the colour number in seven different colours:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ rainbow hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">31</span><span class="token plain"> - </span><span class="token builtin class-name">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> - </span><span class="token builtin class-name">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">33</span><span class="token plain"> - </span><span class="token builtin class-name">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">34</span><span class="token plain"> - </span><span class="token builtin class-name">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">35</span><span class="token plain"> - </span><span class="token builtin class-name">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">36</span><span class="token plain"> - </span><span class="token builtin class-name">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">37</span><span class="token plain"> - </span><span class="token builtin class-name">test</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We have to be careful when formatting output. It can be helpful for a user in an interactive shell (on many systems for example even the <code>ls</code> command is actually an alias for <code>ls --color=auto</code> meaning that the <code>ls</code> command uses colours in its output). But there are circumstance when we don&#x27;t want to use colour codes. Let&#x27;s see what we get when we write the <code>rainbow</code> output to a file:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ rainbow hello &gt;&gt; text.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cat -v text.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">31 - ^[[0;31mhello^[[0m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">32 - ^[[0;32mhello^[[0m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">33 - ^[[0;33mhello^[[0m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">34 - ^[[0;34mhello^[[0m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">35 - ^[[0;35mhello^[[0m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">36 - ^[[0;36mhello^[[0m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">37 - ^[[0;37mhello^[[0m</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The &#x27;-v&#x27; parameter tells <code>cat</code> to make escape characters visible. If you open the in a text editor you will see the same escape characters written in the file.</p><p>This shows the problem with the <code>rainbow</code> function - it adds the colour escape sequences even when we are writing the results to a file. In most cases this is <em>not</em> going to be what we want. Commands like <code>ls</code> do not include colour codes when writing to a file.</p><p>There is not an entirely fool-proof way to avoid this issue, but the most common pattern I have seen is to check whether the standard output file descriptor is associated with a terminal. We can do this using the <code>-t</code> expression of the <code>test</code> command:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -t </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;We are writing to a terminal&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;We are not writing to a terminal&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You will see <code>-t 1</code> in a number of scripts as a way to check whether the output is going to a terminal device. The <code>-t</code> test returns success if the provided file descriptor is associated with a terminal device. The file descriptor &#x27;1&#x27; is the descriptor for the <em>stdout</em> stream (if this is unfamiliar, check <a href="/part-2-core-skills/navigating-your-system/">Chapter 7 - Thinking in Pipelines</a>).</p><p>Here&#x27;s how we could use the test in our rainbow function:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function-name function" style="color:#d73a49">rainbow</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">message</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">local</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">reset</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;</span><span class="token string entity" style="color:#36acaa">\e</span><span class="token string" style="color:#e3116c">[0m&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token variable punctuation" style="color:#393A34">((</span><span class="token variable" style="color:#36acaa">colour</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable number" style="color:#36acaa">31</span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa"> colour</span><span class="token variable operator" style="color:#393A34">&lt;=</span><span class="token variable number" style="color:#36acaa">37</span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable" style="color:#36acaa"> colour</span><span class="token variable operator" style="color:#393A34">++</span><span class="token variable punctuation" style="color:#393A34">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">colour_code</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\\</span><span class="token string" style="color:#e3116c">e[0;</span><span class="token string variable" style="color:#36acaa">${colour}</span><span class="token string" style="color:#e3116c">m&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -t </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin class-name">printf</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${colour}</span><span class="token string" style="color:#e3116c"> - </span><span class="token string variable" style="color:#36acaa">${colour_code}</span><span class="token string variable" style="color:#36acaa">${message}</span><span class="token string variable" style="color:#36acaa">${reset}</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token builtin class-name">printf</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${colour}</span><span class="token string" style="color:#e3116c"> - </span><span class="token string variable" style="color:#36acaa">${message}</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This version of the function will not write the ANSI escape sequences if the output device is not a terminal, meaning that if we run:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ rainbow test &gt; text.txt</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then the output file will not contain escape sequences. You can find out more about the <code>-t</code> test by running <code>man test</code>.</p><p>As a final tip - if you are formatting output you should consider using the <code>tput</code> (<em>query terminfo database</em>) command<!-- --> to make your code more readable and portable:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">green</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">tput setaf </span><span class="token variable number" style="color:#36acaa">2</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># set ansi foreground to &#x27;2&#x27; (green)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">reset</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">tput sgr0</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># reset the colours</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> -e </span><span class="token string" style="color:#e3116c">&quot;Do you like </span><span class="token string variable" style="color:#36acaa">${green}</span><span class="token string" style="color:#e3116c">apples</span><span class="token string variable" style="color:#36acaa">${reset}</span><span class="token string" style="color:#e3116c">?&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The &#x27;tput&#x27; command is quite advanced, but you can search online for more details (the manual pages for the command are hard to decipher as it can be used for many operations and is complex).</p><p>The <em>~/effective-shell/scripts/common.sh</em> script includes colourised output and also checks to see whether colour codes should be printed based - you can use this as a reference for your own scripts.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="checking-the-operating-system">Checking the Operating System<a class="hash-link" href="#checking-the-operating-system" title="Direct link to heading">â€‹</a></h2><p>Different flavours of Unix and Linux can behave quite differently. A common requirement is to write scripts that are portable and can be used across systems. However, this is not always possible. There are times when we need to check to see whether we are on a specific operating system and take a specific action.</p><p>You will often see the <code>uname</code> (<em>show operating system name</em>) command used to check the operating system:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">uname</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Darwin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">os</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;OSX&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Linux</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">os</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Linux&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CYGWIN*</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">MINGW32*</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">MSYS*</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">MINGW*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">os</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Windows&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SunOS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">os</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Solaris&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Unsupported operating system&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">esac</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Your OS is: </span><span class="token string variable" style="color:#36acaa">${os}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The <em>~/effective-shell/scripts/common.sh</em> script checks to see whether the operating system is OSX and if so, temporarily aliases the text commands such as <code>sed</code> to their GNU equivalent, as the OSX versions of the commands are based on BSD so have slightly different parameters. You can use this script as an example of how to deal with OSX in shell scripts that are designed to be used on Linux as well as OSX.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="checking-for-installed-programs">Checking for Installed Programs<a class="hash-link" href="#checking-for-installed-programs" title="Direct link to heading">â€‹</a></h2><p>As we saw in <a href="/part-2-core-skills/understanding-commands">Chapter 10 - Understanding Commands</a> there are many different ways to determine whether a command is available. The most correct and portable way to test to see whether a command is available is to use the <code>command -v</code> command as shown below:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token builtin class-name">command</span><span class="token plain"> -v </span><span class="token string" style="color:#e3116c">&quot;curl&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">/dev/null </span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&#x27;curl&#x27; is not installed, please install and try again&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note that when we&#x27;re using the <code>command</code> command, we silence error output and standard output. This is required because otherwise we would see an error message written to the screen if the command doesn&#x27;t exit or would see the details of the command if it does exist.</p><p>The <em>~/effective-shell/scripts/common.sh</em> script checks to see whether certain GNU versions of tools are installed when running on OSX. You can refer to this script for an example of checking for the presence of commands.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="using-select-to-show-a-menu">Using &#x27;Select&#x27; to Show a Menu<a class="hash-link" href="#using-select-to-show-a-menu" title="Direct link to heading">â€‹</a></h2><p>The <code>select</code> compound command<!-- --> prints a menu and allows the user to make a selection. It is not part of the Posix standard, but is available in Bash and most Bash-like shells.</p><p>Here&#x27;s how we could ask a user to select their favourite fruit from a list:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">fruit</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> Apple Banana Cherry Durian</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;You chose: </span><span class="token string variable" style="color:#36acaa">$fruit</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;This is item number: </span><span class="token string environment constant" style="color:#36acaa">$REPLY</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If we run these commands we will see output like the below:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">1) Apple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2) Banana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3) Cherry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4) Durian</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#? 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You chose: Apple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is item number: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#? 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You chose: Cherry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is item number: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#? 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You chose: Durian</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is item number: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#? ^D</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Notice that <code>select</code> will run just like an infinite loop - after the statements in the select body are run, the selection is offered again. The user can either end transmission with the <code>^D</code> character or press <code>^C</code> to quit.</p><p>You will normally see the <code>select</code> used with a <code>case</code> statement to process the selection. This is something you may come across in scripts so is useful to be aware of.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="running-commands-in-subshells">Running Commands in Subshells<a class="hash-link" href="#running-commands-in-subshells" title="Direct link to heading">â€‹</a></h2><p>You will often see a nice little trick that allows you to change the current directory for a specific command, without affecting the current directory for the shell.</p><p>Here&#x27;s how this trick will look:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mkdir -p ~/new-project</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> ~/new-project</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">touch</span><span class="token plain"> README.md</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The brackets around the statements mean that these commands are run in a sub-shell. Because they run in a sub-shell, they change the directory in the sub-shell only, not the current shell. This means we don&#x27;t need to change <em>back</em> to the previous directory after the commands have completed.</p><p>This sequence of commands would create a new folder (we use <code>mkdir -p</code> so that if the folder exists the command does not fail), then change to the folder, then create a new file called <em>README.md</em>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="anti-patterns">Anti-Patterns<a class="hash-link" href="#anti-patterns" title="Direct link to heading">â€‹</a></h2><p>Anti-patterns are techniques that you may see but should be avoided. I have noted a few here as you will likely see them in your travels and should know why they are problematic.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="configuring-options-in-shebangs">Configuring Options in Shebangs<a class="hash-link" href="#configuring-options-in-shebangs" title="Direct link to heading">â€‹</a></h3><p>You will sometimes see shebangs in shell scripts that contain options, like so:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/usr/bin/bash -ex</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Script contents below...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>It is possible to specify the arguments to the program that is used to execute the script in the shebang. In the case above, the <code>-ex</code> flags are passed to the <code>bash</code> program, enabling the &#x27;exit on error&#x27; and &#x27;trace&#x27; options.</p><p>I include this pattern because it is possible you will see it in other scripts, but please do not do this. There are a two particular reasons that it is risky.</p><p>The first is that pattern requires that you know the path to the shell. As we saw in <a href="/part-3-manipulating-text/shell-script-essentials/">Chapter 18 - Shell Script Essentials</a>, we should use the <code>#!/usr/bin/env</code> program so that we search the <code>$PATH</code> for the shell rather than assuming that we know the location of the shell program.</p><p>The second reason is that multiple parameters are not handled consistently across operating systems. For example, on some Unix systems the following shebang will run <code>bash</code> with the <code>-e</code> parameter:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#!/usr/bin/env bash -e</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>However, on many Unix distributions only one parameter is passed. This would mean that the <code>-e</code> parameter would be silently ignored, which would be very confusing for the reader.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="complex-logic-in-shell-scripts">Complex Logic in Shell Scripts<a class="hash-link" href="#complex-logic-in-shell-scripts" title="Direct link to heading">â€‹</a></h3><p>The shell is amazing. Considering how long it has been around, it has in many ways changed remarkably little in the last few decades. This is a testament to the genius of the design of Unix systems and the shell in general.</p><p>However, the shell is <em>not</em> generally going to be the best choice for any kind of complex logic or work. Shell scripts are great for automating simple tasks, creating utilities to help you out, but come with many challenges. The syntax can be confusing, making scripts work across multiple systems can be challenging, and there are not many features to help you write robust code.</p><p>Perhaps the biggest anti-pattern in shell scripts is to simply let them get to large and do too much with them. There comes a certain point where you will almost certainly create a more portable, performant and maintainable solution to your problem using a dedicated programming language like Python (which is available on almost all systems) or one of the many other languages available.</p><p>This is a topic we discuss in detail in the <a href="/work-in-progress">Chapter 24 - How to avoid shell scripting</a>, but for now I would just say that as soon as your script starts to get longer than a page, or takes more than a few minutes to reason about, then you might be reaching the point that a programming language could be a better option.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="scripts-without-shebangs">Scripts without Shebangs<a class="hash-link" href="#scripts-without-shebangs" title="Direct link to heading">â€‹</a></h3><p>You might find shell scripts that do not have a shebang at the top. This is something that you should avoid. The shebang gives you a way to be very explicit about <em>what</em> shell is required to run your script.</p><p>For example, if I see a shebang like this:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/usr/bin/env sh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then my assumption would be that this script can run on <em>any</em> Posix compliant shell, i.e. it is as compatible as possible. However, if I see this:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/usr/bin/env bash</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then the assumption would be that this script is Bash-specific and uses &quot;Bash-isms&quot;, such as the <code>if [[ conditional ]]</code> construct. Finally, if I was to see a shebang like this:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/usr/bin/env zsh</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then I would expect that this script has been explicitly written to be used with Z-Shell.</p><p>If you do not include a shebang in a script, then the behaviour can be ambiguous. For example, at the time of writing, if you run a shell script without a shebang from a Bash shell, then the script will be run using a new instance of Bash. However, if you run a shell script without a shebang from Z-Shell then Z-Shell will use <code>sh</code> from your path. But depending on your system, <code>sh</code> may be a symlink to <code>dash</code>, or <code>bash</code>, or another shell.</p><p>Scripts that do not have shebangs are inherently ambiguous and will run using different shells depending on the shell used to execute the script as well as the operating system.</p><p>If you want to experiment and see what shell runs a script, create a script such as the <em>~/effective-shell/scripts/nobang.sh</em> script that looks like this:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># nobang: This script shows an anti-pattern - not using a shebang in a shell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># script. It shows the process tree to for the shell that runs the script:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pstree </span><span class="token variable" style="color:#36acaa">$$</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If I run this script from MacOS, the output below is shown:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">-+= 00001 root /sbin/launchd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> \-+= 07995 dwmkerr tmux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   \-+= 31195 dwmkerr /bin/zsh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     \-+= 49833 dwmkerr sh ./samples/script/nobang.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       \-+- 49834 dwmkerr pstree -p 49833</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         \--- 49835 root ps -axwwo user,pid,ppid,pgid,command</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Although I ran the script from a Z-Shell session, it was executed with <code>sh</code>, which is the Bourne Shell (version 3 on my system).</p><p>The only time you should omit the shebang is if you expect the script to be <em>sourced</em> - we will see sourcing in the next part of the book.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">â€‹</a></h2><p>In this chapter we saw an assortment of common patterns that can be useful when building shell scripts. In the next part of the book we&#x27;re going to look at how you can customise your shell and environment to build your own toolkit!</p><div class="footnotes"><hr><ol><li id="fn-1">The value shown before each trace line can be configured by setting the <code>$PS4</code> variable.<a href="#fnref-1" class="footnote-backref">â†©</a></li></ol></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/dwmkerr/dwmkerr/main/docs/04-shell-scripting/23-useful-patterns-for-shell-scripts/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/part-4-shell-scripting/functions-parameters-and-error-handling"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Functions, Parameters and Error Handling</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/part-5-building-your-toolkit/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Part 5 - Building Your Toolkit</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ensuring-exit-on-failure" class="table-of-contents__link toc-highlight">Ensuring Exit on Failure</a></li><li><a href="#debugging-shell-scripts" class="table-of-contents__link toc-highlight">Debugging Shell Scripts</a></li><li><a href="#checking-for-existing-variables-or-functions" class="table-of-contents__link toc-highlight">Checking for Existing Variables or Functions</a></li><li><a href="#unsetting-values" class="table-of-contents__link toc-highlight">Unsetting Values</a></li><li><a href="#traps" class="table-of-contents__link toc-highlight">Traps</a></li><li><a href="#handling-options" class="table-of-contents__link toc-highlight">Handling Options</a></li><li><a href="#colouring-output" class="table-of-contents__link toc-highlight">Colouring Output</a></li><li><a href="#checking-the-operating-system" class="table-of-contents__link toc-highlight">Checking the Operating System</a></li><li><a href="#checking-for-installed-programs" class="table-of-contents__link toc-highlight">Checking for Installed Programs</a></li><li><a href="#using-select-to-show-a-menu" class="table-of-contents__link toc-highlight">Using &#39;Select&#39; to Show a Menu</a></li><li><a href="#running-commands-in-subshells" class="table-of-contents__link toc-highlight">Running Commands in Subshells</a></li><li><a href="#anti-patterns" class="table-of-contents__link toc-highlight">Anti-Patterns</a><ul><li><a href="#configuring-options-in-shebangs" class="table-of-contents__link toc-highlight">Configuring Options in Shebangs</a></li><li><a href="#complex-logic-in-shell-scripts" class="table-of-contents__link toc-highlight">Complex Logic in Shell Scripts</a></li><li><a href="#scripts-without-shebangs" class="table-of-contents__link toc-highlight">Scripts without Shebangs</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Effective Shell</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/effective-shell" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/dwmkerr" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Dave Kerr. Website built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9510d0b1.js"></script>
<script src="/assets/js/main.3718e50c.js"></script>
</body>
</html>